{{- range .Values.networkPolicies }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .name }}-platform-policy
  namespace: {{ .namespace }}
  labels:
    {{- include "apl-network-policies.labels" $ | nindent 4 }}
    app: {{ .name }}
spec:
  podSelector: {}
  policyTypes:
    {{- if .ingress }}
    - Ingress
    {{- end }}
    {{- if or .disableEgress .egress }}
    - Egress
    {{- end }}
  {{- if or .ingress .platformAccess }}
  ingress:
  {{- end }}
    {{- if .platformAccess }}
    # Default platform access - allow from Istio system
    - from:
        - namespaceSelector:
            matchLabels:
              name: istio-system
    # Allow monitoring access
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app.kubernetes.io/instance: po-prometheus
    # Allow APL operator access
    - from:
        - namespaceSelector:
            matchLabels:
              name: apl-operator
    {{- end }}
    {{- if .ingress }}
    {{- .ingress | toYaml | nindent 4 }}
    {{- end }}
  {{- if .egress }}
  egress:
    {{- if .egress }}
    {{- .egress | toYaml | nindent 4 }}
    {{- end }}
  {{- end }}
{{- end }}
