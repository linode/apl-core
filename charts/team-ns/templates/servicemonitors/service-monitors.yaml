{{- $v := .Values | merge (dict) }}
{{- if not (eq $v.teamId "admin") }}
{{- $ns := .Release.Namespace }}
{{- $hasProm := dig "managedMonitoring" "prometheus" false $v }}
{{- $hasAlert := dig "managedMonitoring" "alertmanager" false $v }}
{{- $hasGraf := dig "managedMonitoring" "grafana" false $v }}
{{- if $hasAlert }}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    prometheus: system
  name: po-alertmanager-team-{{ $v.teamId }}
  namespace: {{ $ns }}
spec:
  endpoints:
  - enableHttp2: true
    path: /metrics
    port: http-web
  namespaceSelector:
    matchNames:
    - team-{{ $v.teamId }}
  selector:
    matchLabels:
      app: {{ $v.teamId }}-po-alertmanager
      release: prometheus-{{ $v.teamId }}
{{- end }}
---
{{- if $hasProm }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    prometheus: system
  name: po-prometheus-team-{{ $v.teamId }}
spec:
  endpoints:
  - path: /metrics
    port: http-web
  namespaceSelector:
    matchNames:
    - team-{{ $v.teamId }}
  selector:
    matchLabels:
      app: {{ $v.teamId }}-po-prometheus
      release: prometheus-{{ $v.teamId }}
{{- end }}
{{- end }}
---
{{- if $hasGraf }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    prometheus: system
  name: po-grafana-team-{{ $v.teamId }}
spec:
  endpoints:
  - honorLabels: true
    path: /metrics
    port: http-web
    scheme: http
    scrapeTimeout: 30s
  namespaceSelector:
    matchNames:
    - team-{{ $v.teamId }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $v.teamId }}-po-grafana
      app.kubernetes.io/instance: prometheus-{{ $v.teamId }}
{{- end }}
---
{{- end }}