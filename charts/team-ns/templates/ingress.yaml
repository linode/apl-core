{{- $ns := .Release.Namespace }}
{{- $v := .Values }}
{{- $appsDomain := printf "apps.%s" $v.domain }}
{{- if or (eq $v.teamId "admin") ($v.cluster.isMultitenant) }}
{{- $authSvc := (eq $v.teamId "admin" | ternary "oauth2-proxy" (printf "oauth2-proxy-team-%s" $v.teamId)) }}
# split list of services into separate ingress types:
# - auth: public vs private
# - forward path: forwarded (only exists to massage some core 'apps.*')
# - custom domain (not 'apps.*'): custom
{{- $public := list }}
{{- $private := list }}
{{- $privateForward := list }}
{{- $privateCustom := list }}
{{- range $s := $v.services }}
  {{- if not $s.internal }}
    {{- if not $s.host }}
      {{- if $s.isPublic }}
        {{- $public = (append $public $s) }}
      {{- else }}
        {{- if or $s.domain $s.ownHost $s.isShared }}
          {{- $privateCustom = (append $privateCustom $s) }}
        {{- else }}
          {{- if $s.forwardPath -}}
            {{- $privateForward = (append $privateForward $s) }}
          {{- else }}
            {{- $private = (append $private $s) }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{- $private = (append $private $s) }}
    {{- end }}
  {{- end }}
{{- end }}

# apps.* that need their path rewritten to /
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "isApps" true "hasForward" false "hasAuth" true "services" $private) }}
---

# apps.* that need their path forwarded instead of rewritten to /
{{- if gt (len $privateForward) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private-forward" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "isApps" true "hasForward" true "hasAuth" true "services" $privateForward) }}
---
{{- end }}

# apps with custom domains
{{- if gt (len $privateCustom) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private-custom" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "isApps" false "hasForward" false "hasAuth" true "services" $privateCustom) }}
---
{{- end }}

# public services
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "public" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "isApps" false "hasForward" false "hasAuth" false "services" $public) }}
---

{{- if $v.cluster.hasCloudLB }}
# external LB ingress
{{ include "ingress" (dict "dot" . "provider" $v.cluster.provider "name" "external" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "isApps" false "hasForward" false "hasAuth" false "services" $v.services) }}
---
{{- end }}

{{- if gt (len $v.proxies) 0 }}
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    {{- if not $v.cluster.hasCloudLB }}
    externaldns: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    {{- end }}
    nginx.ingress.kubernetes.io/upstream-vhost: $1.{{ $v.domain }}
    nginx.ingress.kubernetes.io/rewrite-target: $2
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    # nginx.ingress.kubernetes.io/limit-connections: "20" # per ip
    # nginx.ingress.kubernetes.io/limit-rps: "5" # per second per conn
    # nginx.ingress.kubernetes.io/limit-rpm: "30" # per minute per conn
    # nginx.ingress.kubernetes.io/limit-rate-after: "50000000" # After 50Mb throughput rate limiting will start
    # nginx.ingress.kubernetes.io/limit-rate: "0" # stop after
  labels: {{- include "chart-labels" . | nindent 4 }}
  name: nginx-team-{{ $v.teamId }}-proxy
  namespace: istio-system
spec:
  rules:
  {{ range $p := $v.proxies }}
  - host: proxy.{{ $v.domain }}
    http:
      paths:
      - backend:
          serviceName: istio-ingressgateway
          servicePort: 80
        path: /({{ $p.name }})({{ $p.path }})
  {{- end }}
  {{- if not $v.cluster.hasCloudLB }}
  tls:
    - hosts:
        - {{ printf "proxy.%s" $v.domain }}
      secretName: proxy-{{ $v.domain | replace "." "-" }}
  {{- end }}
{{- end }}
{{- end }}
