{{- $ns := .Release.Namespace }}
{{- $v := .Values }}
{{- $k := $v.charts.keycloak | default dict }}
{{- $hasKeycloak := $k.enabled | default true }}
{{- $appsDomain := printf "apps.%s" $v.domain }}
{{- if or (eq $v.teamId "admin") ($v.otomi.isMultitenant) }}
{{- $authSvc := (eq $v.teamId "admin" | ternary "oauth2-proxy" (printf "oauth2-proxy-team-%s" $v.teamId)) }}
# split list of services into separate ingress types:
# - auth: public vs private
# - forward path: forwarded (only exists to massage some core 'apps.*')
# - custom domain (not 'apps.*'): custom
{{- $public := list }}
{{- $private := list }}
{{- $tls := list }}
{{- $privateForward := list }}
{{- $privateCustom := list }}
{{- range $s := $v.services }}
  {{- $type := $s.type | default "auth" }}
  {{- if eq $type "tlsPass" }}
    {{- $tls = append $tls $s }}
  {{- else if and (not (eq $type "cluster")) (not $s.host ) }}
    {{- if eq $type "public" }}
      {{- $public = append $public $s }}
    {{- else }}
      {{- if or $s.domain $s.ownHost $s.isShared }}
        {{- $privateCustom = append $privateCustom $s }}
      {{- else }}
        {{- if $s.forwardPath -}}
          {{- $privateForward = append $privateForward $s }}
        {{- else }}
          {{- $private = append $private $s }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

# tls passthrough
{{- if gt (len $tls) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "tlspass" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi "isApps" false "hasForward" false "hasAuth" false "services" $tls "tlsPass" true) }}
---
{{- end }}

# apps.* that need their path rewritten to /
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi "isApps" true "hasForward" false "hasAuth" true "services" $private) }}
---

# apps.* that need their path forwarded instead of rewritten to /
{{- if gt (len $privateForward) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private-forward" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi  "isApps" true "hasForward" true "hasAuth" true "services" $privateForward) }}
---
{{- end }}

# apps with custom domains
{{- if gt (len $privateCustom) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "private-custom" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi  "isApps" false "hasForward" false "hasAuth" true "services" $privateCustom) }}
---
{{- end }}

# public services
{{- if gt (len $public) 0 }}
{{ include "ingress" (dict "dot" . "provider" "nginx" "name" "public" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi  "isApps" false "hasForward" false "hasAuth" false "services" $public) }}
---
{{- end }}

{{- if $v.otomi.hasCloudLB }}
# external LB ingress
{{ include "ingress" (dict "dot" . "provider" $v.cluster.provider "name" "external" "teamId" $v.teamId "domain" $v.domain "cluster" $v.cluster "clusterDomainSuffix" $v.clusterDomainSuffix "otomi" $v.otomi  "isApps" false "hasForward" false "hasAuth" false "services" $v.services) }}
---
{{- end }}

{{- end }}
