{{- $v := .Values }}
{{- $p := index $v.policies "orcs-compliance" }}
{{- if and (get (index $v.apps "kyverno") "enabled") $p $v.linodeLkeImageRepository (get (index $v.apps "prometheus") "enabled") }}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: orcs-compliance-team
  labels:
    {{- include "team-ns.chart-labels" $ | nindent 4 }}
    prometheus: system
spec:
  groups:
    - name: orcs-compliance-team
      rules:
        - alert: ORCSTeamPolicyViolation
          annotations:
            description: >
              ORCS compliance policy violations detected in team namespace {{ .Release.Namespace }}.
              policy violations in the last 5 minutes.
              Team workloads are not complying with ORCS registry requirements.
            summary: '[Team ORCS] Policy violations in {{ .Release.Namespace }}'
            runbook_url: 'https://docs.example.com/runbooks/team-orcs-compliance'
          expr: |
            increase(kyverno_policy_results_total{
              policy_name=~"orcs-compliance.*",
              namespace="{{ include "team-ns.fullname" . }}",
              result="fail"
            }[5m]) > 0
          for: 1m
          labels:
            severity: warning
            component: orcs-compliance
            team: "{{ include "team-ns.fullname" . }}"
            namespace: "{{ include "team-ns.fullname" . }}"

        - alert: ORCSTeamPolicyViolationCritical
          annotations:
            description: >
              Critical ORCS compliance violations in team namespace {{ .Release.Namespace }}.
              violations in the last 10 minutes indicates systematic
              non-compliance. Team deployment pipelines may be bypassing ORCS requirements.
            summary: '[Team ORCS] Critical violations in {{ .Release.Namespace }}'
            runbook_url: 'https://docs.example.com/runbooks/team-orcs-critical'
          expr: |
            increase(kyverno_policy_results_total{
              policy_name=~"orcs-compliance.*",
              namespace="{{ include "team-ns.fullname" . }}",
              result="fail"
            }[10m]) > 10
          for: 1m
          labels:
            severity: critical
            component: orcs-compliance
            team: "{{ include "team-ns.fullname" . }}"
            namespace: "{{ include "team-ns.fullname" . }}"

        - alert: ORCSTeamComplianceRateHigh
          annotations:
            description: >
              Team {{ .Release.Namespace }} has high ORCS non-compliance rate.
               of deployments are violating ORCS policies.
              Review team deployment processes and exemption configurations.
            summary: '[Team ORCS] High non-compliance rate in {{ .Release.Namespace }}'
            runbook_url: 'https://docs.example.com/runbooks/team-orcs-rate'
          expr: |
            (
              increase(kyverno_policy_results_total{
                policy_name=~"orcs-compliance.*",
                namespace="{{ include "team-ns.fullname" . }}",
                result="fail"
              }[1h])
              /
              (
                increase(kyverno_policy_results_total{
                  policy_name=~"orcs-compliance.*",
                  namespace="{{ include "team-ns.fullname" . }}",
                  result="fail"
                }[1h])
                +
                increase(kyverno_policy_results_total{
                  policy_name=~"orcs-compliance.*",
                  namespace="{{ include "team-ns.fullname" . }}",
                  result="pass"
                }[1h])
              )
            ) * 100 > 50
            and
            increase(kyverno_policy_results_total{
              policy_name=~"orcs-compliance.*",
              namespace="{{ include "team-ns.fullname" . }}",
              result="fail"
            }[1h]) > 5
          for: 15m
          labels:
            severity: warning
            component: orcs-compliance
            team: "{{ include "team-ns.fullname" . }}"
            namespace: "{{ include "team-ns.fullname" . }}"

        - alert: ORCSTeamExemptionOveruse
          annotations:
            description: >
              Team {{ .Release.Namespace }} is overusing ORCS policy exemptions.
              exemptions triggered in the last hour.
              Review exemption rules and ensure they're not overly broad.
            summary: '[Team ORCS] Exemption overuse in {{ .Release.Namespace }}'
            runbook_url: 'https://docs.example.com/runbooks/team-orcs-exemptions'
          expr: |
            increase(kyverno_policy_results_total{
              policy_name=~"orcs-compliance.*",
              namespace="{{ include "team-ns.fullname" . }}",
              result="skip"
            }[1h]) > 20
          for: 5m
          labels:
            severity: info
            component: orcs-compliance
            team: "{{ include "team-ns.fullname" . }}"
            namespace: "{{ include "team-ns.fullname" . }}"
{{- end }}
