{{- $v := .Values }}
{{- $ := . }}
{{- if or (eq $v.teamId "admin") ($v.cluster.isMultitenant) }}
{{- if eq $v.teamId "admin" }}
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: keycloak-jwt
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway-auth
  jwtRules:
    - issuer: http://keycloak-http.keycloak/realms/master
      jwksUri: http://keycloak-http.keycloak/realms/master/protocol/openid-connect/certs
      # audiences:
      #   - otomi
---
{{- end }}
{{- range $s := $v.services }}
{{- if hasKey $s "mtls" }}
{{- if or (hasKey $s.mtls "gatewayDisabled") (hasKey $s.mtls "policyMode") }}
# yyy
{{- $mode := (index $s.mtls "policyMode" | default "permissive") }}
{{- $ns := index $s "namespace" | default $.Release.Namespace }}
{{- $svc := (hasKey $s "hasPrefix" | ternary (printf "%s-%s" $v.teamId $s.name) $s.name) }}
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: team-{{ $v.teamId }}-{{ $s.name }}-{{ $mode }}
  labels: {{- include "chart-labels" $ | nindent 4 }}
spec:
  mtls:
    mode: {{ $mode | upper }}
  selector:
    matchLabels: {{- toYaml $s.workloadSelector | nindent 6 }}
---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
