{{- $v := .Values }}
{{- $k := $v.charts.keycloak | default dict }}
{{- if or (eq $v.teamId "admin") ($v.otomi.isMultitenant) }}
{{- $ := . }}
{{- range $s := $v.services }}
{{- $ns := index $s "namespace" | default $.Release.Namespace }}
{{- if not (or $s.internal (hasKey $s "host")) }}
{{- $svc := (hasKey $s "hasPrefix" | ternary (printf "%s-%s" $v.teamId ($s.svc | default $s.name)) ($s.svc | default $s.name)) }}
{{- $shared := (and $s.isCore (eq $v.teamId "admin") (hasKey $s "isShared")) | default false}}
{{- $knativeServiceDomain := printf "%s.%s" $s.name $v.domain }}
{{- $domain := (index $s "domain" | default (printf "%s.%s" $s.name ($shared | ternary $v.cluster.domain $v.domain))) }}
{{- if not (and $s.ksvc (eq $knativeServiceDomain $domain)) }}
{{- $vsName := include "flatten-name" (printf "%s%s" $domain (hasKey $s "paths" | ternary (printf "-%s" (include "helm-toolkit.utils.joinListWithSep" (dict "list" $s.paths "sep" "|"))) "")) }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ $vsName }}
  labels: {{- include "chart-labels" $ | nindent 4 }}
    {{- if not (hasKey $s "isPublic") }}
    auth: "true"
    {{- end }}
spec:
  gateways:
  {{- if hasKey $s "ksvc" }}
  - knative-serving/knative-ingress-gateway
  {{- else }}
  - {{ $.Release.Namespace }}/team-{{ $v.teamId }}-{{ hasKey $s "isPublic" | ternary "public" "auth" }}
  {{- end }}
  hosts:
  - {{ $domain }}
  http:
    - match:
      - uri:
          prefix: /logout-otomi
      redirect:
        authority: auth.{{ $v.cluster.domain }}
        uri: /oauth2/sign_out?rd=https://keycloak.{{ $v.cluster.domain }}/realms/master/protocol/openid-connect/logout?redirect_uri=https://{{ printf "otomi.%s" $v.cluster.domain }}
      # route:
      #   - destination:
      #       host: istio-ingressgateway.istio-system.svc.cluster.local
    -
    {{- if hasKey $s "paths" }}
      match:
      {{- range $path := $s.paths }}
        {{- if eq $path "/" }}
        - uri:
            prefix: /
        {{- else }}
        - uri:
            prefix: '{{ $path }}'        
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if or (hasKey $s "ksvc") (not (hasKey $s "forwardPath")) }}
      rewrite:
      {{- if hasKey $s "ksvc" }}
        authority: {{ $s.name }}.{{ $v.domain }}
      {{- end }}
      {{- if not (hasKey $s "forwardPath") }}
        uri: /
      {{- end }}
    {{- end }}
    {{- if hasKey $s "ksvc" }}
      route:
        - destination:
            host: istio-ingressgateway.istio-system.svc.cluster.local
    {{- else }}
      route:
        - destination:
            host: {{ $svc }}.{{ $ns }}.svc.cluster.local
    {{- end }}
            port:
              number: {{ $s.port | default 80 }}
      # fix for istio (=envoy) incorrectly setting proto to http
      # (@see https://github.com/istio/istio/issues/7964):
          headers:
            request:
              set:
                X-Forwarded-Proto: https
---
{{- if and (not (hasKey $s "isPublic")) (hasKey $s "authz") }}
{{- $workload := ($s.authz.workload | toYaml | replace "__TEAM" $v.teamId) }}
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: {{ $vsName }}
  namespace: {{ $ns }}
spec:
  selector:
    matchLabels: {{ $workload | nindent 6 }}
  jwtRules:
  {{- if $k.enabled }}
    - issuer: https://keycloak.{{ $v.cluster.domain }}/realms/master
      jwksUri: https://keycloak.{{ $v.cluster.domain }}/realms/master/protocol/openid-connect/certs
      audiences:
        - {{ $k.idp.clientID }}
  {{- else }}
    - issuer: {{ $v.oidc.issuer }}
  {{- end }}
      forwardOriginalToken: {{ $s.authz.forwardOriginalToken | default false }}
---    
{{- if $k.enabled }}
{{- $realm := $k.realm | default "master" }}
{{- $principal := printf "https://keycloak.%s/realms/%s/*" $v.cluster.domain $realm }}
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ $vsName }}
  namespace: {{ $ns }}
spec:
  selector:
    matchLabels: {{ $workload | nindent 6 }}
  action: ALLOW
  rules:
    -
      # {}
      from: 
        - source:
            requestPrincipals: [{{ $principal }}]
      {{- if not $s.isShared }}
      when:
        - key: request.auth.claims[groups]
          values: [{{ if not (eq $v.teamId "admin") }}team-{{ $v.teamId }},{{ end }}team-admin,admin]
      {{- end }}
      to:
        - operation:
            {{- with $s.authz.paths }}
            paths:
              {{- range $path := . }}
              - {{ $path }}
              {{- end }}
            {{- end }}
            hosts: [{{ $domain }}]
            {{- if $s.authz.excludePaths }}
            notPaths: [{{ include "helm-toolkit.utils.joinListWithSep" (dict "list" $s.authz.excludePaths "sep" ",") }}]
            {{- end }}
    - from:
        - source:
            notRequestPrincipals: [{{ $principal }}]
---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
