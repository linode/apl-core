{{- $v := .Values }}
{{- if $v.apps.harbor.enabled }}
{{- $domain := printf "harbor.%s" $v.cluster.domainSuffix }}
{{- $cm := index $v.apps "cert-manager" }}
{{- $ingress :=  $v.ingress.platformClass }}

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    externaldns: "true"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    nginx.ingress.kubernetes.io/enable-modsecurity: "false"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "false"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    {{- with $ingress.sourceIpAddressFiltering }}
    nginx.ingress.kubernetes.io/whitelist-source-range: "{{ . }}"
    {{- end}}
    {{- if and (hasKey $ingress "entrypoint") (ne $ingress.entrypoint "")}}
    external-dns.alpha.kubernetes.io/target: {{ $ingress.entrypoint }} 
    {{- end }}
  labels: {{- include "team-ns.chart-labels" . | nindent 4 }}
  name: nginx-team-{{ $v.teamId }}-platform-public-open-forward-harbor
  namespace: {{ if ne $.provider "nginx" }}ingress{{ else }}istio-system{{ end }}
spec:
  ingressClassName: platform
  rules:
    - host: $domain
      http:
        paths:
        - backend:
            service:
              name: istio-ingressgateway-public
              port:
                number: 80
          path: /chartrepo/
          pathType: Prefix
        - backend:
            service:
              name: istio-ingressgateway-public
              port:
                number: 80
          path: /service/
          pathType: Prefix
        - backend:
            service:
              name: istio-ingressgateway-public
              port:
                number: 80
          path: /v1/
          pathType: Prefix
        - backend:
            service:
              name: istio-ingressgateway-public
              port:
                number: 80
          path: /v2/
          pathType: Prefix
  tls:
    - hosts:
        - $domain
      {{- if eq $cm.issuer "byo-wildcard-cert" }}
      secretName: otomi-byo-wildcard-cert
      {{- else }}
      secretName: otomi-cert-manager-wildcard-cert
      {{- end}}
{{- end }}