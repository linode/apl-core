{{- $v := .Values }}

{{- range $v.workloads }}
{{- $workload := . }}
{{- $imageUpdateStrategyType :=  $workload | get "imageUpdateStrategy.type"  "disabled" }}
{{- $includeManagedValuesFile :=  not (eq ( $imageUpdateStrategyType  "disabled ")) }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: 'team-{{ $v.teamId }}-{{ .name }}'
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  {{- if and ( eq $v.teamId "admin" ) .namespace }}
  project: 'default' # project is not restricted
  {{- else }}
  project: 'team-{{ $v.teamId }}' # project is restricted
  {{- end }}
  sources:
  - repoURL: '{{ .url }}'
    targetRevision: '{{ .revision }}'
    path: '{{ .path }}'
    chart: '{{ .chart }}'
    helm:
      releaseName: '{{ .name }}'
      {{- if and (.sidecarInject) (.createNamespace) }}
      parameters:
        - name: sidecar.istio.io/inject
          value: 'true'
        {{- if $v.apps.istio.defaultRevision }}
        - name: istio.io/rev
          value: {{ $v.apps.istio.defaultRevision | quote }}
        {{- end }}
      {{- end }}
      valueFiles:
      - $values/env/teams/{{ $v.teamId }}/workloadValues/{{ $workload.name }}.yaml
      {{- if $includeManagedValuesFile }}
      - $values/env/teams/{{ $v.teamId }}/workloadValues/{{ $workload.name }}.managed.yaml
      {{- end }}
  - repoURL: {{ $v.gitOps.workloadValuesRepoUrl | quote }}
    targetRevision: '{{ .revision }}'
    ref: values
  syncPolicy:
    automated:
      allowEmpty: false
      prune: false
      selfHeal: true
    retry:
      backoff:
        duration: 10s
        factor: 3
      limit: 3
    {{- if eq $v.teamId "admin" }}
    syncOptions:
      - RespectIgnoreDifferences=true
      - ServerSideApply=true
      {{- if .createNamespace }}
      - CreateNamespace=true
      {{- end }}
  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
      - '.webhooks[]?.clientConfig.caBundle'
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
      - '.webhooks[]?.clientConfig.caBundle'
    - group: "apps"
      kind: "StatefulSet"
      jqPathExpressions:
        - ".spec.volumeClaimTemplates[].apiVersion"
        - ".spec.volumeClaimTemplates[].kind"
        - ".spec.volumeClaimTemplates[].spec"
    {{- end }}
  destination:
    server: 'https://kubernetes.default.svc'
    {{- if and ( eq $v.teamId "admin" ) .namespace }}
    namespace: '{{- .namespace }}'
    {{- else }}
    namespace: 'team-{{ $v.teamId }}'
    {{- end }}
{{- end }}
