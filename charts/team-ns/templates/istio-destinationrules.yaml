{{- $v := .Values }}
{{- if and (not $v.cluster.useCloudCA) (or (eq $v.teamId "admin") ($v.cluster.isMultitenant)) }}
{{- $ := . }}
{{- range $s := $v.services }}
{{- if (hasKey $s "mtls") }}
{{- if (index $s.mtls "gatewayDisabled") }}
{{- $ns := index $s "namespace" | default $.Release.Namespace }}
{{- $svc := (hasKey $s "hasPrefix" | ternary (printf "%s-%s" $v.teamId $s.svc) $s.svc) }}
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ $s.name }}-notls
  labels: {{- include "chart-labels" $ | nindent 4 }}
spec:
  host: {{ $svc }}.{{ $ns }}.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
---      
{{- end }}
{{- end }}
{{- end }}
{{- end }}
