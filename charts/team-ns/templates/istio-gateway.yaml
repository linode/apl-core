{{- $v := .Values }}
{{- if or (eq $v.teamId "admin") ($v.cluster.isMultitenant) }}
# collect unique domains for this GW
{{- $domains := list }}
{{- $tlsDomains := list }}
{{- range $s := $v.services }}
{{- $shared := (and $s.isCore (eq $v.teamId "admin") (hasKey $s "isShared")) }}
{{- if and (or (hasKey $s "domain") $shared ) (not (hasKey $s "ksvc")) }}
{{- $domain := (index $s "domain" | default (printf "%s.%s" $s.name ($shared | ternary $v.cluster.domain $v.domain))) }}
{{- if $s.tlsPass }}
  {{- if not (has $domain $tlsDomains) }}
    {{- $tlsDomains = (append $tlsDomains $domain) }}
  {{- end }}
{{- else }}
  {{- if not (has $domain $domains) }}
    {{- $domains = (append $domains $domain) }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: team-{{ $v.teamId }}
  labels: {{- include "chart-labels" . | nindent 4 }}
spec:
  selector:
    istio: ingressgateway
  servers:
  - hosts:
      - '*.{{ $v.domain }}'
      {{- range $domain := $domains }}
      - {{ $domain }}
      {{- end }}
    port:
      name: http
      number: 80
      protocol: HTTP
  {{- range $domain := $tlsDomains }}
  - hosts:
      - {{ $domain }}
    tls:
      credentialName: {{ $domain | replace "." "-" }}
      mode: SIMPLE
      privateKey: sds
      serverCertificate: sds
    port:
      number: 443
      name: https-{{ $domain | replace "." "-" }}
      protocol: HTTPS
  {{- end }}
{{- end }}
