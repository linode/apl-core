{{- $v := .Values }}
{{- $ := . }}
{{- range $name, $spec := $v.tasks }}
{{- if and $spec.enabled (eq $spec.type "job") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ join "-" (list $name  uuidv4) | trunc 63 }}
  labels: {{- include "jobs.labels" $ | nindent 4 }}
spec:
  template:
    metadata:
      labels: {{- include "jobs.labels" $ | nindent 8 }}
      annotations:
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") $ | sha256sum | trunc 63 }}
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") $ | sha256sum | trunc 63 }}
        {{- range $key, $value := $spec.annotations }}
        {{ $key }}: {{ $value | quote }}
        {{- end }}
    spec:
      serviceAccountName: {{ $spec.serviceAccountName | default "default" }}
      {{- with $spec.podSecurityContext }}
      securityContext: {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $spec.init }}
      initContainers:
      - image: "{{ $spec.init.image.repository }}:{{ $spec.init.image.tag | default "latest" }}"
        imagePullPolicy: "{{ $spec.init.image.pullPolicy | default "IfNotPresent"}}"
        name: "{{ $name }}-init"
        command: ["{{ $spec.init.shell | default "sh" }}", "-c"]
        args:
          - |
            {{- toString $spec.init.script | nindent 12 }}
        {{- with $spec.init.securityContext }}
        securityContext: {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      containers:
      - image: "{{ $spec.image.repository }}:{{ $spec.image.tag }}"
        imagePullPolicy: "{{ $spec.image.pullPolicy }}"
        name: "{{ $name }}"
        command: ["{{ $spec.shell | default "sh" }}", "-c"]
        args:
          - |
            {{- toString $spec.script | nindent 12 }}
        resources: {{- if $spec.resources}}{{ toYaml $spec.resources | nindent 10 }}{{ else }}{{ toYaml $v.resources | nindent 10 }}{{ end }}
        envFrom:
        {{- if $spec.secret }}
        - secretRef:
            name: {{ $name }}
        {{- end }}
        {{- if $spec.env }}
        - configMapRef:
            name: {{ $name }}
        {{- end }}
        volumeMounts:
          - name: fakeroot
            mountPath: /fakeroot.pem
            subPath: fakeroot.pem
          {{- if $spec.mounts }}
          {{- $spec.mounts | toYaml | nindent 10 }}
          {{- end }}
        {{- with $spec.securityContext }}
        securityContext: {{- toYaml . | nindent 10 }}
        {{- end }}
      restartPolicy: Never
      volumes:
        - name: fakeroot
          configMap:
            name: fakeroot
        {{- if $spec.volumes }}
        {{- $spec.volumes | toYaml | nindent 8 }}
        {{- end }}
  backoffLimit: 3
  ttlSecondsAfterFinished: {{ $spec.ttlSecondsAfterFinished | default 86400 }}
---
{{- end }}
{{- end }}
