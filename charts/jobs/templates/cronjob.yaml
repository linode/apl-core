{{- $v := .Values }}
{{- if and (default true $v.enabled) (eq $v.type "cronjob") }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: job-{{ $v.name }}
  labels: {{- include "jobs.labels" $ | nindent 4 }}
spec:
  schedule: "{{ $v.schedule }}"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 300
  suspend: false
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ $v.serviceAccountName | default "default" }}
          containers:
            - image: "{{ $v.image.repository }}:{{ $v.image.tag }}"
              imagePullPolicy: "{{ $v.image.pullPolicy }}"
              name: {{ $v.name }}
              command: ["bash", "-c"]
              args:
                - |
                  {{- toString $v.script | nindent 18 }}
              resources:
                limits:
                  cpu: 200m
                  memory: 256Mi
                requests:
                  cpu: 100m
                  memory: 128Mi
              {{- if or $v.secret $v.env }}
              envFrom:
              {{- if $v.secret }}
              - secretRef:
                  name: job-{{ $v.name }}
              {{- end }}
              {{- if $v.env }}
              - configMapRef:
                  name: {{ $v.name }}
              {{- end }}
              {{- end }}
          restartPolicy: Never
---
{{- end }}