{{- $v := .Values }}
{{- range $spec := $v.jobs }}
{{- if and (default true $spec.enabled) (eq $spec.type "cronjob") }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: job-{{ $spec.name }}
  labels: {{- include "jobs.labels" $ | nindent 4 }}
spec:
  schedule: "{{ $spec.schedule }}"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 300
  suspend: false
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ $spec.serviceAccountName | default "default" }}
          containers:
            - image: "{{ $spec.image.repository }}:{{ $spec.image.tag }}"
              imagePullPolicy: "{{ $spec.image.pullPolicy }}"
              name: {{ $spec.name }}
              command: ["bash", "-c"]
              args:
                - |
                  {{- toString $spec.script | nindent 18 }}
              resources:
                limits:
                  cpu: 200m
                  memory: 256Mi
                requests:
                  cpu: 100m
                  memory: 128Mi
              {{- if or $spec.secret $spec.env }}
              envFrom:
              {{- if $spec.secret }}
              - secretRef:
                  name: job-{{ $spec.name }}
              {{- end }}
              {{- if $spec.env }}
              - configMapRef:
                  name: {{ $spec.name }}
              {{- end }}
              {{- end }}
          restartPolicy: Never
---
{{- end }}
{{- end }}
