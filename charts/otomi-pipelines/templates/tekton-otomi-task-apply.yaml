apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: otomi-task-apply
  namespace: otomi-pipelines
spec:
  params:
    - name: OTOMI_VERSION
      type: string
    - name: CI
      type: string
  workspaces:
    - name: source
      mountPath: /home/app/stack/env
  steps:
    - name: apply
      image: otomi/core:$(params["OTOMI_VERSION"])
      workingDir: $(workspaces.source.path)
      env:
        - name: AZURE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: otomi-sops-secrets
              key: AZURE_CLIENT_ID
        - name: AZURE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: otomi-sops-secrets
              key: AZURE_CLIENT_SECRET
        - name: AZURE_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: otomi-sops-secrets
              key: AZURE_TENANT_ID
        - name: CI
          value: $(params["CI"])
        - name: IN_DOCKER
          value: '1'
      command:
        - '/bin/bash'
      args:
        - '-c'
        - 'git config --global --add safe.directory $(pwd) && ../binzx/otomi apply'  #TODO: Fix mounted directory permissions
