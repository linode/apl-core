{{- $kms := .Values.kms | default dict }}

apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: otomi-task
  namespace: otomi-pipelines
spec:
  params:
    - name: OTOMI_VERSION
      type: string
    - name: CI
      type: string
    - name: repoUrl
      type: string
    - name: giteaCredentialsSecretName
      type: string
  workspaces:
    - name: source
      mountPath: /home/app/stack/env
    - name: gitea-credentials
      mountPath: /etc/gitea-credentials
  stepTemplate:
    computeResources: {{- toYaml .Values.tektonTask.resources | nindent 6 }}
    imagePullPolicy: Always
    image: linode/apl-core:$(params["OTOMI_VERSION"])
    workingDir: /home/app/stack
{{- if hasKey $kms "sops" }}
    envFrom:
    - secretRef:
        name: otomi-sops-secrets
{{- end }}
    env:
    - name: CI
      value: $(params["CI"])
    - name: IN_DOCKER
      value: 'false'
    - name: ENV_DIR
      value: /home/app/stack/env
    - name: VERBOSE
      value: '1'
  steps:
    - name: git-clone
      computeResources: {}
      script: |
        #!/bin/bash
        set -e
        # Prevent the detected dubious ownership in repository error
        git config --global --add safe.directory '*'
        # Reading gitea credentials
        GITEA_USERNAME=$(cat /etc/gitea-credentials/username)
        GITEA_PASSWORD=$(cat /etc/gitea-credentials/password)

        # Parsing the repo url
        export fullRepoUrl=$(params["repoUrl"])
        export url=$(echo $fullRepoUrl|sed 's/http\:\/\///')

        # Cloning the values
        {{- if .Values.cloneUnsecure }}
        git clone -c http.sslVerify=false --depth 1 http://$GITEA_USERNAME:$GITEA_PASSWORD@$url $ENV_DIR
        {{- else}}
        git clone --depth 1 http://$GITEA_USERNAME:$GITEA_PASSWORD@$url $ENV_DIR
        {{- end }}
    - name: initwait
      computeResources: {}
      command:
        - '/bin/bash'
      args:
        - '-c'
        - 'sleep 300'
    - name: bootstrap
      computeResources: {}
      command:
        - '/bin/bash'
      args:
        - '-c'
        - 'binzx/otomi bootstrap'
    - name: test
      computeResources: {}
      command:
        - '/bin/bash'
      args:
        - '-c'
        - 'binzx/otomi validate-values'
    - name: wait
      computeResources: {}
      command:
        - '/bin/bash'
      args:
        - '-c'
        - 'sleep 300'
    - name: apply
      computeResources: {}
      script: |
        #!/bin/bash
        set -e
        # Prevent the detected dubious ownership in repository error
        git config --global --add safe.directory '*'
        binzx/otomi apply
