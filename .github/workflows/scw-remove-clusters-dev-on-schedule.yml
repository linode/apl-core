name: Scheduled - remove clusters from Scaleway in the dev project after 19:00

on:
  schedule: # time is in UTC so 17:00 equals 19:00
    - cron: '0 17 * * *'

jobs:
  remove-scw-clusters-on-dev:
    name: 'Delete SCW clusters in dev project'
    runs-on: ubuntu-latest
    steps:
      - name: Install scw-cli
        uses: scaleway/action-scw@v0
      - name: Use Scaleway CLI on dev
        uses: scaleway/action-scw@v0
        with:
          save-config: true
          export-config: true
          version: v2.13.0
          access-key: ${{ secrets.SCW_ACCESS_KEY }}
          secret-key: ${{ secrets.SCW_SECRET_KEY }}
          default-project-id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          default-organization-id: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
      - name: Delete Clusters in DEV
        run: |
          # Set the maximum number of attempts
          max_attempts=5
          # Set a counter for the number of attempts
          attempt_num=1
          # Set a flag to indicate whether the command was successful
          success=false

          while [ $attempt_num -le $max_attempts ] && [ $success = false ]; do
            echo "Attempt $attempt_num"
            # Get the cluster IDs
            SCALEWAY_CLUSTER_IDS=$(scw k8s cluster list region=nl-ams -o json | jq -r '.[] | select(.project_id == "${{ secrets.SCW_DEFAULT_PROJECT_ID }}") | .id')
            # Try deleting the clusters
            echo Trying to delete Cluster\(s\) with ID\(s\): $SCALEWAY_CLUSTER_IDS
            scw k8s cluster delete $SCALEWAY_CLUSTER_IDS with-additional-resources=true region=nl-ams --wait
            # Check if the command was successful
            if [ $? -eq 0 ]; then
              success=true
            else
              # Increment the counter
              attempt_num=$[$attempt_num+1]
              # Wait for 1 min before trying again
              sleep 1m
            fi
          done
      - name: Delete Private Networks in DEV
        run: |
          # Set the maximum number of attempts
          max_attempts=5
          # Set a counter for the number of attempts
          attempt_num=1
          # Set a flag to indicate whether the command was successful
          success=false

          while [ $attempt_num -le $max_attempts ] && [ $success = false ]; do
            echo "Attempt $attempt_num"
            # Get the private network IDs
            PRIVATE_NETWORK_IDS=$(scw vpc private-network list region=nl-ams -o json | jq -r '.[] | select(.project_id == "${{ secrets.SCW_DEFAULT_PROJECT_ID }}") | .id')
            # Try deleting the private networks
            echo Trying to delete Private Network\(s\) with ID\(s\): $PRIVATE_NETWORK_IDS
            scw vpc private-network delete region=nl-ams $PRIVATE_NETWORK_IDS
            # Check if the command was successful
            if [ $? -eq 0 ]; then
              success=true
            else
              # Increment the counter
              attempt_num=$[$attempt_num+1]
              # Wait for 1 min before trying again
              sleep 1m
            fi
          done
