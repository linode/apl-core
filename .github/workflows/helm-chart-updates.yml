name: Helm chart updates
on:
  push:
  workflow_dispatch:
    inputs:
      CI_UPDATE_TYPE:
        description: 'Update type'
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

env:
  GIT_USER: svcAPLBot
  CHECK_CONTEXT: continuous-integration/integration-test
  COMMIT_ID: '${{ github.event.pull_request.head.sha || github.sha }}'
  BOT_EMAIL: ${{ vars.BOT_EMAIL }}
  BOT_USERNAME: ${{ vars.BOT_USERNAME }}
  DEV_DOMAINS: ${{ secrets.DEV_DOMAINS }}

jobs:
  preprocess-input:
    name: Preprocess input variables
    runs-on: ubuntu-latest
    steps:
      - name: Print user input
        run: |
          echo 'CI_UPDATE_TYPE: ${{ inputs.CI_UPDATE_TYPE }}'
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: Install packages
        run: npm install
      - name: Run Docker image check script
        env:
          CI_UPDATE_TYPE: patch
          CI_HELM_CHART_NAME_FILTER: '["cert-manager"]'
          CI_GIT_BASELINE_BRANCH: 'APL-11'
        run: |
          cd ci/ 
          src/update-helm-chart-deps.mjs
