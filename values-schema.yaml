---
'$schema': 'http://json-schema.org/draft-07/schema'
type: object
additionalProperties: false
definitions:
  k8sVersion:
    type: string
    default: '1.18'
    enum: ['1.16', '1.17', '1.18']
    description: The cluster k8s version. Otomi supports 2 minor versions backwards compatibility from the suggested default.
  domain:
    type: string
    pattern: ^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
  repository:
    type: string
    pattern: ^[a-z0-9]+(?:[/._-]{1,2}[a-z0-9]+)*$
    description: A container image repository
  memoryQuantity:
    type: string
    pattern: ^[0-9]+\.?[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$
    description: Amount of memory. Valid units are E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki
    examples:
      - 1Mi
      - 0.5M
  cpuQuantity:
    type: string
    pattern: ^([0-9]+\.[0-9]{1,2})|([0-9]{2,3}m)?$
    description: Amount of cores, or slice of cpu in millis.
    examples:
      - '1'
      - 200m
  env:
    type: string
    pattern: ^[a-zA-Z0-9_]*$
  labelsAnnotations:
    type: object
    patternProperties:
      ? '^((([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9]){1,253}\/)?([a-z0-9A-Z]+[a-z0-9A-Z-_.]+[a-z0-9A-Z]){1,63}$'
      : type: string
        pattern: ^((.){1,253}\/)?(.){1,63}$
  annotations:
    '$ref': '#/definitions/labelsAnnotations'
    description: A set of annotations.
  labels:
    '$ref': '#/definitions/labelsAnnotations'
    description: A set of labels.
  idName:
    type: string
    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
    description: A lowercase name that starts with a letter and may contain dashes.
  image:
    title: Container image
    type: object
    properties:
      pullPolicy:
        type: string
        enum: [IfNotPresent, Always]
        default: IfNotPresent
      repository:
        '$ref': '#/definitions/repository'
      tag:
        type: string
    required: [repository, tag]
  portNumber:
    type: number
    minimum: 80
    maximum: 32768
  resource:
    type: object
    properties:
      cpu:
        '$ref': '#/definitions/cpuQuantity'
      memory:
        '$ref': '#/definitions/memoryQuantity'
    required: [cpu, memory]
  resources:
    title: Pod resources
    description: Compute resources for containers
    type: object
    properties:
      requests:
        description: Requested resources (guaranteed)
        '$ref': '#/definitions/resource'
      limits:
        description: Requested resources (best effort)
        '$ref': '#/definitions/resource'
  alerts:
    properties:
      groupInterval:
        type: string
        default: 5m
        description: How long to wait before sending a notification about new alerts that are added to a group of alerts for which an initial notification has already been sent. (Usually ~5m or more.)
      repeatInterval:
        type: string
        default: 3h
        description: How long to wait before sending a notification again if it has already been sent successfully for an alert. (Usually ~3h or more).
      receiver:
        type: string
        enum:
          - slack
          - msteams
        default: slack
        description: A notification receiver. You can only choose one of Slack or MS Teams in simple configuration mode.
      slack:
        type: object
        properties:
          url:
            type: string
            description: A Slack webhook URL.
          channel:
            type: string
            default: mon-otomi
            description: 'The Slack channel for non-critical notifications. This channel, as well as one with the suffix "-crit" (for criticals) should exist.'
        required: [url]
      msteams:
        type: object
        properties:
          highPrio:
            type: string
            description: The low prio web hook
          lowPrio:
            type: string
            description: The high prio web hook
        required: [highPrio, lowPrio]
    required: [receiver]
  cloud:
    properties:
      domain:
        '$ref': '#/definitions/domain'
      clusters:
        patternProperties:
          '^[a-z-]+$':
            '$ref': '#/definitions/cluster'
        additionalProperties: false
    required: [domain, clusters]
  cluster:
    type: object
    properties:
      apiName:
        type: string
        description: Only used for API/UI to show in app.
      apiServer:
        type: string
        description: Used by kubectl for local deployment to target cluster.
      dnsZones:
        type: array
        items:
          '$ref': '#/definitions/domain'
        description: Extra dns zones that the cluster can administer (see dns). Team services can use this to publish their URLs on.
      domain:
        '$ref': '#/definitions/domain'
        description: Base cloud domain for the cluster domain. Also added to list of dns zones in the Otomi Console.
      k8sVersion:
        '$ref': '#/definitions/k8sVersion'
      otomiVersion:
        type: string
        default: latest
        description: 'Please pin this a valid release version found in the repo. Suggestion: try the most recent stable version.'
      region:
        type: string
        description: Dependent on provider.
        examples:
          - europe-west4
          - eu-central-1
          - westeurope
      vpcID:
        type: string
        description: AWS only. If provided will override autodiscovery from metadata.
    required: [apiServer, k8sVersion, otomiVersion, region]
  team:
    properties:
      azure:
        type: object
      id:
        '$ref': '#/definitions/idName'
        description: Must be the same as the name.
      oidc:
        oidc:
          properties:
            groupMapping:
              type: string
              description: IDP group id to map onto this team.
      password:
        type: string
        description: Will be used to separate team resources.
      services:
        type: array
        items:
          type: object
          properties:
            id:
              type: string
              description: Unique identifier created by and used in API. Optional.
            isPublic:
              type: boolean
              description: If true then no SSO will be used.
              default: false
            name:
              '$ref': '#/definitions/idName'
              description: Short name. Will be used for generation of knative service name, as well as service URL.
            ownHost:
              type: boolean
              description: When true the service will get it's own domain by prefixing the app name to the team domain. Mostly set to true. This will probably be removed soon.
              default: true
              # deprecated: true
            ksvc:
              type: object
              description: Details for a knative service that will be deployed and operated.
              properties:
                scaleToZero:
                  title: Scale to zero
                  description: Scales to zero after 60 seconds and needs approximately 8 seconds to start back up.
                  type: boolean
                  default: false
                image:
                  title: Container image
                  type: object
                  nullable: true
                  properties:
                    repository:
                      '$ref': '#/definitions/repository'
                    tag:
                      type: string
                secrets:
                  type: array
                  title: Secrets
                  nullable: true
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      entries:
                        title: Entries
                        type: array
                        items:
                          type: string
                        uniqueItems: true
                    required: [name]
                  required: [repository, tag]
                env:
                  title: Environment variables
                  # description: Environment variables for containers
                  type: array
                  nullable: true
                  items:
                    type: object
                    properties:
                      name:
                        '$ref': '#/definitions/env'
                      value:
                        type: string
                        maxLength: 131072
                    required: [name, value]
                resources:
                  '$ref': '#/definitions/resources'
                annotations:
                  '$ref': '#/definitions/annotations'
                autoCD:
                  title: Continuous delivery pipeline
                  description: NOT IN USE YET! Deploys new images based on a tagging strategy.
                  type: object
                  oneOf:
                    - title: 'Off'
                      nullable: true
                      additionalProperties: false
                    - title: Semver versioning
                      nullable: true
                      properties:
                        tagMatcher:
                          type: string
                          enum: [semver]
                          default: semver
                        semver:
                          title: Semver version pattern
                          type: string
                          example: 'PATCH only: "~1.1", MINOR and PATCH only "~1", ALL "*",  ">=1.2.3-0"'
                          description:
                            'Use this filter if your images tags follow semantic versioning rules (MAJOR.MINOR.PATCH). E.g.:
                            PATCH only: "~1.1", MINOR and PATCH only "~1", ALL "*"'
                      required: [semver]
                    - title: Glob pattern matching
                      properties:
                        tagMatcher:
                          type: string
                          enum: [glob]
                          default: glob
                        glob:
                          title: Glob string pattern
                          type: string
                          description: 'Use this filter if you want to make simple non-standard patterns. E.g.: "master-v1.*.*"'
                          example: 'master-v1.*.*'
                      required: [glob]
                      additionalProperties: false
            svc:
              '$ref': '#/definitions/idName'
              description: When given a backing k8s service is expected to be deployed with this name, which will be exposed through this team service.
            isShared:
              type: boolean
              description: When true the service will get it's own domain by prefixing the app name to the cluster domain. Mostly used by core apps.
            paths:
              type: array
              items:
                type: string
                description: |
                  Path mapping to only let this path go to the service. This allows micro services to operate on the same domain and port.
                  When left empty all paths will go to this service.
            forwardPath:
              type: boolean
              description: Wether to forward the path into the service, or 'terminate' it.
              default: false
            port:
              '$ref': '#/definitions/portNumber'
              description: Points to the backing k8s service (only used when 'svc' is set).
              default: 80
            authz:
              type: object
              description: Identifies a workload to authorize.
              properties:
                forwardOriginalToken:
                  type: boolean
                  description: If true istio will forward the bearer token instead of removing it from the headers.
                  default: false
                workload:
                  '$ref': '#/definitions/labelsAnnotations'
          required: [id, name]
    required: [id]
properties:
  alerts:
    '$ref': '#/definitions/alerts'
  charts:
    type: object
    properties:
      jobs:
        type: object
        patternProperties:
          'certs-aws|harbor|ingress-azure|keycloak':
            type: object
            properties:
              image:
                '$ref': '#/definitions/image'
      cert-manager:
        type: object
        properties:
          email:
            type: string
          provider:
            type: object
            patternProperties:
              '(aws|azure|google)':
                type: object
                properties:
                  clouddns:
                    type: object
                    properties:
                      project:
                        type: string
                      serviceAccountSecretRef:
                        type: object
                        properties:
                          key:
                            type: string
                          name:
                            type: string
          stage:
            type: string
            description: |
              The Let’s Encrypt environment that is used for issuing certificates.
              The 'production' environment issues trusted certificates but has narrow rate limits, whereas the 'staging' environment issues untrusted certificates but provides broader rate limits.
              Read more about rate limits: https://letsencrypt.org/docs/rate-limits/
            enum: ['staging', 'production']
      cluster-overprovisioner:
        type: object
        properties:
          enabled:
            type: boolean
          memory:
            '$ref': '#/definitions/memoryQuantity'
          cpu:
            '$ref': '#/definitions/cpuQuantity'
      drone:
        type: object
        properties:
          adminUser:
            type: string
          githubAdmins:
            type: object
            properties:
              org:
                type: string
              team:
                type: string
              token:
                type: string
          orgsFilter:
            type: string
          repoFilter:
            type: string
          resources:
            properties:
              runner:
                '$ref': '#/definitions/resources'
              server:
                '$ref': '#/definitions/resources'
          sourceControl:
            type: object
            properties:
              github:
                type: object
                properties:
                  clientID:
                    type: string
                  clientSecretValue:
                    type: string
                  server:
                    type: string
              provider:
                type: string
      external-dns:
        type: object
        properties:
          domainFilters:
            type: array
            items:
              type: string
          logLevel:
            type: string
            enum: [debug, info, warning, error]
            default: info
          zoneIdFilters:
            type: array
            items:
              type: string
      gatekeeper-operator:
        type: object
        properties:
          enabled:
            type: boolean
      harbor:
        type: object
        properties:
          adminPassword:
            type: string
          enabled:
            type: boolean
          persistence:
            type: object
            properties:
              imageChartStorage:
                type: object
                properties:
                  gcs:
                    type: object
                    properties:
                      bucket:
                        type: string
                      encodedkey:
                        type: string
                      rootdirectory:
                        type: string
                  type:
                    type: string
          secretKey:
            type: string
      istio:
        type: object
        properties:
          addonComponents:
            type: object
            properties:
              grafana:
                type: object
                properties:
                  enabled:
                    type: boolean
              kiali:
                type: object
                properties:
                  enabled:
                    type: boolean
              prometheus:
                type: object
                properties:
                  enabled:
                    type: boolean
              tracing:
                type: object
                properties:
                  enabled:
                    type: boolean
          gateways:
            type: object
            properties:
              istio-egressgateway:
                type: object
                properties:
                  resources:
                    '$ref': '#/definitions/resources'
              istio-ingressgateway:
                type: object
                properties:
                  resources:
                    '$ref': '#/definitions/resources'
          global:
            type: object
            properties:
              logging:
                type: object
                properties:
                  level:
                    type: string
              mtls:
                type: object
                properties:
                  enabled:
                    type: boolean
              proxy:
                type: object
                properties:
                  resources:
                    '$ref': '#/definitions/resources'
              sds:
                type: object
                properties:
                  enabled:
                    type: boolean
          mixer:
            type: object
            properties:
              policy:
                type: object
                properties:
                  enabled:
                    type: boolean
                  resources:
                    '$ref': '#/definitions/resources'
              telemetry:
                type: object
                properties:
                  enabled:
                    type: boolean
                  resources:
                    type: object
                    properties:
                      limits:
                        type: object
                        properties:
                          cpu:
                            type: string
                          memory:
                            type: string
                      requests:
                        type: object
                        properties:
                          cpu:
                            type: string
                          memory:
                            type: string
          pilot:
            type: object
            properties:
              resources:
                '$ref': '#/definitions/resources'
              traceSampling:
                type: number
      keycloak:
        type: object
        properties:
          enabled:
            type: boolean
          idp:
            type: object
            properties:
              alias:
                type: string
          realm:
            type: string
      loki:
        type: object
        properties:
          adminPassword:
            type: string
          persistence:
            type: object
            properties:
              size:
                type: string
          retention:
            type: object
            properties:
              duration:
                type: string
              period:
                type: string
          storageType:
            type: string
      nginx-ingress:
        type: object
        properties:
          autoscaling:
            type: object
            properties:
              enabled:
                type: boolean
      oauth2-proxy:
        type: object
        properties:
          config:
            type: object
            properties:
              cookieSecret:
                type: string
      otomi-api:
        type: object
        properties:
          git:
            type: object
            properties:
              branch:
                type: string
              email:
                type: string
              localPath:
                type: string
              password:
                type: string
              repoUrl:
                type: string
              user:
                type: string
          image:
            type: object
            properties:
              pullPolicy:
                type: string
              tag:
                type: string
          tools:
            type: object
            properties:
              gcloudServiceKey:
                type: string
              image:
                type: object
                properties:
                  tag:
                    type: string
      otomi-web:
        type: object
        properties:
          image:
            type: object
            properties:
              pullPolicy:
                type: string
              tag:
                type: string
      prometheus-operator:
        type: object
        properties:
          alertmanager:
            type: object
            properties:
              groupInterval:
                type: string
              receiver:
                type: string
              repeatInterval:
                type: string
              slack:
                type: object
                properties:
                  channel:
                    type: string
                  url:
                    type: string
          grafana:
            type: object
            properties:
              adminPassword:
                type: string
          prometheus:
            type: object
            properties:
              storageSize:
                type: string
      redis-shared:
        type: object
        properties:
          enabled:
            type: boolean
      sitespeed:
        type: object
        properties:
          enabled:
            type: boolean
          pvc:
            type: object
            properties:
              graphite:
                type: string
              results:
                type: string
          retention:
            type: string
          schedule:
            type: string
  clouds:
    type: object
    patternProperties:
      '^.*$':
        '$ref': '#/definitions/cloud'
    additionalProperties: false
  customer:
    type: object
    properties:
      name:
        type: string
  oidc:
    type: object
    properties:
      clientID:
        type: string
      clientSecret:
        type: string
      idp:
        type: object
        properties:
          adminGroupID:
            type: string
          clientID:
            type: string
          clientSecret:
            type: string
          issuer:
            type: string
          teamAdminGroupID:
            type: string
          tenantID:
            type: string
      scope:
        type: string
  otomi:
    type: object
    properties:
      hasCloudLB:
        type: boolean
        description:
          Set this to true when an external LB exists or needs to be started (AWS ALB, Azure AppGW, Google Apigee).
          This will then be configured through ingress controllers. Expects existing LBs to terminate https.
          Currently this is only working correctly for Azure, and not for AWS and Google. AWS is close to completion.
        default: false
      isManaged:
        type: boolean
        description: Wether masters are managed and not under control. Set this to false when onprem.
        default: true
      isMultitenant:
        type: boolean
        description: Wether to separate team metrics and logs. Disabling this lets everybody be admin and see everything.
        default: true
      isRedkubesMonitored:
        type: boolean
        description: Wether this cluster is monitored under a RedKubes Premium SLA. Sends all notifications to RedKubes.
        default: false
      pullSecret:
        type: string
        description: The pullsecret to deploy the Otomi API and Console. Requires an Otomi license.
        default: ''
      teamPrefix:
        type: string
        default: team-
        description: The prefix to use in URLs for team domains.
        pattern: ^[a-z]+[-]{1}$
  sops:
    description: DON'T EDIT THIS YOURSELF! This is a SOPS governed property. Exists here only to avoid warnings in console.
  teamConfig:
    type: object
    properties:
      teams:
        type: object
        patternProperties:
          '^[a-z-]+$':
            '$ref': '#/definitions/team'
        additionalProperties: false

  cluster:
    type: object
    properties:
      apiName:
        type: string
      apiServer:
        type: string
      dnsProvider:
        type: string
      domain:
        type: string
      entrypoint:
        type: string
        description: A public IP address used by DNS record to map public domian with cluster Ingress gateway (applicable to onprem provider)
      k8sVersion:
        type: string
      name:
        type: string
      otomiVersion:
        type: string
      provider:
        type: string
      region:
        type: string
    required:
      - apiName
      - apiServer
      - domain
      - k8sVersion
      - name
      - otomiVersion
      - provider
      - region
  k8s:
    type: object
    properties:
      namespaces:
        type: array
        items:
          type: object
          properties:
            disableIstioInjection:
              type: boolean
            name:
              type: string
          required:
            - name
    required:
      - namespaces

  proxies:
    type: array
    items:
      type: object
      properties:
        name:
          type: string
        namespace:
          type: string
        path:
          type: string
      required:
        - name
        - namespace
        - path
  redkubesSlackUrl:
    type: string
  services:
    type: array
    items:
      type: object
      properties:
        isPublic:
          type: boolean
        name:
          type: string
        namespace:
          type: string
        ownHost:
          type: boolean
        svc:
          type: string
        isShared:
          type: boolean
        paths:
          anyOf:
            - type: 'null'
            - type: array
              items:
                type: string
        forwardPath:
          type: boolean
        hide:
          type: boolean
        port:
          type: integer
        authz:
          type: object
          properties:
            forwardOriginalToken:
              type: boolean
            workload:
              type: object
              properties:
                app.kubernetes.io/name:
                  type: string
                app.kubernetes.io/instance:
                  type: string
                app:
                  type: string
                component:
                  type: string
          required:
            - workload
        host:
          type: string
        path:
          type: string
        logo:
          type: object
          properties:
            name:
              type: string
          required:
            - name
      required:
        - name
        - namespace
        - svc

  toolsVersion:
    type: string
