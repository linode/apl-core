{{- $v := .Values }}
{{- $k := $v.apps.keycloak }}
{{- $obj := $v.obj.provider }}

resources:
- apiVersion: v1
  kind: Secret
  metadata:
    name: custom-ca
  data:
    custom-ca.pem: {{ .Values._derived.caCert | b64enc }}
- apiVersion: external-secrets.io/v1beta1
  kind: ExternalSecret
  metadata:
    name: keycloak-initial-admin
    namespace: keycloak
  spec:
    refreshInterval: 1h
    secretStoreRef:
      name: core-secrets-store
      kind: ClusterSecretStore
    target:
      name: keycloak-initial-admin
      creationPolicy: Owner
      template:
        type: Opaque
        data:
          password: '{{ "{{ .adminPassword | b64enc }}" }}'
          username: {{ $k.adminUsername | b64enc }}
    data:
      - secretKey: adminPassword
        remoteRef:
          key: otomi-platform-secrets
          property: adminPassword
{{- if eq $obj.type "linode" }}
- apiVersion: external-secrets.io/v1beta1
  kind: ExternalSecret
  metadata:
    name: linode-creds
  spec:
    refreshInterval: 1h
    secretStoreRef:
      name: core-secrets-store
      kind: ClusterSecretStore
    target:
      name: linode-creds
      creationPolicy: Owner
      template:
        type: Opaque
        data:
          S3_STORAGE_ACCOUNT: '{{ "{{ .accessKeyId | b64enc }}" }}'
          S3_STORAGE_KEY: '{{ "{{ .secretAccessKey | b64enc }}" }}'
    data:
      - secretKey: accessKeyId
        remoteRef:
          key: obj-storage-secrets
          property: linode_accessKeyId
      - secretKey: secretAccessKey
        remoteRef:
          key: obj-storage-secrets
          property: linode_secretAccessKey
{{- end }}
