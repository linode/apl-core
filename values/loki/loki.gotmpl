{{- $v := .Values -}}
{{- $l := $v.apps.loki }}
{{- $obj := $v.obj.provider }}
{{- $useObjectStorage := eq $obj.type "minioLocal" "linode" }}

{{- with .Values.otomi | get "globalPullSecret" nil }}
imagePullSecrets:
- name: otomi-pullsecret-global
{{- end }}

global:
  {{- with $v.otomi.linodeLkeImageRepository }}
  image:
    registry: {{ . }}/docker
  {{- end }}
  priorityClassName: otomi-critical
  {{- if eq $v.cluster.linode.tier "enterprise" }}
  dnsService: "coredns"
  {{- else }}
  dnsService: "kube-dns"
  {{- end }}
  commonConfig:
    replication_factor: 1
serviceMonitor:
  enabled: true
  labels:
    prometheus: system

loki:
  podAnnotations:
    sidecar.istio.io/inject: "false"
  schemaConfig:
    configs:
      - from: "2020-09-07"
      {{- if $l.v13SchemaStartDate }}
        store: boltdb-shipper
        {{- if $useObjectStorage }}
        object_store: s3
        {{- else }}
        object_store: filesystem
        {{- end }}
        schema: v11
        index:
          prefix: loki_index_
          period: 24h
      - from: {{ $l.v13SchemaStartDate | toString | trunc 10 }}
      {{- end }}
        store: tsdb
        {{- if $useObjectStorage }}
        object_store: s3
        {{- else }}
        object_store: filesystem
        {{- end }}
        schema: v13
        index:
          prefix: index_
          period: 24h
  ingester:
    chunk_encoding: snappy
  querier:
    max_concurrent: 4
  storage_config:
    {{- if $l.v13SchemaStartDate }}
    boltdb_shipper:
      active_index_directory: /var/loki/index
      cache_location: /var/loki/index_cache
      resync_interval: 5s
    {{- end }}
    tsdb_shipper:
      active_index_directory: /var/loki/tsdb_index
      cache_location: /var/loki/tsdb_index_cache
      cache_ttl: 24h
  {{- if $useObjectStorage }}
  storage:
    bucketNames:
      chunks: {{ $obj.linode.buckets.loki | quote }}
      ruler: {{ $obj.linode.buckets.loki | quote }}
      admin: {{ $obj.linode.buckets.loki | quote }}
    s3:
      {{- if eq $obj.type "minioLocal" }}
      s3: http://otomi-admin:{{ $v.otomi.adminPassword }}@minio.minio.svc.cluster.local.:9000/loki
      insecure: true
      {{- else if eq $obj.type "linode" }}
      s3: https://{{ $obj.linode.accessKeyId }}:{{ $obj.linode.secretAccessKey }}@{{ $obj.linode.region }}.linodeobjects.com
      http_config:
        idle_conn_timeout: 90s
        insecure_skip_verify: true
      backoff_config:
        min_period: 2s
        max_period: 5s
      {{- end }}
      s3ForcePathStyle: true
  {{- else }}
  storage:
    type: filesystem
  {{- end }}
  structuredConfig:
    limits_config:
      discover_service_name:
        # Added
        - app
        - deployment
        # Defaults
        - service
        - application
        - app_name
        - name
        - app_kubernetes_io_name
        - container
        - container_name
        - k8s_container_name
        - component
        - workload
        - job
        - k8s_job_name
      otlp_config:
        resource_attributes:
          ignore_defaults: true
          attributes_config:
            - action: index_label
              attributes:
                - app
                - component
                - container
                - deployment
                - namespace
                - node_name

deploymentMode: Distributed

ingester:
  replicas: 3
  maxUnavailable: 1
  resources: {{ $l.resources.ingester | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.ingester | toYaml | nindent 4 }}

  zoneAwareReplication:
    enabled: false

gateway:
  replicas: 1
  resources: {{ $l.resources.gateway | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.gateway | toYaml | nindent 4 }}

querier:
  replicas: 1
  resources: {{ $l.resources.querier | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.querier | toYaml | nindent 4 }}

  {{- if not $useObjectStorage }}
  persistence:
    enabled: true
    size: {{ $l | get "persistence.querier.size" "10Gi" }}
    storageClass: {{ $v.cluster.defaultStorageClass }}
  {{- end }}

distributor:
  replicas: 1
  resources: {{ $l.resources.distributor | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.distributor | toYaml | nindent 4 }}

queryFrontend:
  replicas: 1
  resources: {{ $l.resources.queryFrontend | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.queryFrontend | toYaml | nindent 4 }}
  podAnnotations:
    checksum/team-config: {{ ( toString (keys $v.teamConfig | sortAlpha ) ) | sha256sum }}
  extraContainers:
  - name: reverse-proxy
    {{- with $v.otomi.linodeLkeImageRepository }}
    image: {{ . }}/docker/k8spin/loki-multi-tenant-proxy:v1.0.0
    {{- else }}
    image: k8spin/loki-multi-tenant-proxy:v1.0.0
    {{- end }}
    args:
      - "run"
      - "--port=3101"
      - "--loki-server=http://localhost:3100"
      - "--auth-config=/etc/reverse-proxy-conf/authn.yaml"
    ports:
      - name: auth
        containerPort: 3101
        protocol: TCP
    resources: {{- $l.resources.reverseProxy | toYaml | nindent 6 }}
    volumeMounts:
      - name: reverse-proxy-auth-config
        mountPath: /etc/reverse-proxy-conf
  extraVolumes:
  - name: reverse-proxy-auth-config
    secret:
      secretName: reverse-proxy-auth-config
  extraPorts:
  - port: 3101
    protocol: TCP
    name: http
    targetPort: http

queryScheduler:
  replicas: 1
  resources: {{ $l.resources.queryScheduler | toYaml | nindent 4 }}
  autoscaling: {{ $l.autoscaling.queryScheduler | toYaml | nindent 4 }}

indexGateway:
  replicas: 1
  resources: {{ $l.resources.indexGateway | toYaml | nindent 4 }}

compactor:
  replicas: 1
  resources: {{ $l.resources.compactor | toYaml | nindent 4 }}

  {{- if not $useObjectStorage }}
  persistence:
    enabled: true
    size: {{ $l | get "persistence.compactor.size" "10Gi" }}
    storageClass: {{ $v.cluster.defaultStorageClass }}
  {{- end }}

ruler:
  enabled: false

# Zero out replica counts of other deployment modes
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0

singleBinary:
  replicas: 0

resultsCache:
  enabled: false
chunksCache:
  enabled: false

test:
  enabled: false
lokiCanary:
  enabled: false
memcachedExporter:
  enabled: false
