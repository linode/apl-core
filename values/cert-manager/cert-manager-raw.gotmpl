{{- $v := .Environment.Values }}
{{- $cm := index $v.charts "cert-manager" }}
{{- $provider := $v.cluster.provider }}
{{- $certTpl := readFile "../../helmfile.d/snippets/certificate.gotmpl" }}
{{- $labels := readFile "../../helmfile.d/snippets/labels.yaml" | fromYaml }}
{{- $vars := tpl (readFile "../../helmfile.d/snippets/domains.gotmpl") $v | fromYaml }}
resources:
{{- if eq $v.cluster.provider "azure" }}
  {{- $ap := $cm.provider.azure.azuredns }}
  - apiVersion: v1
    kind: Secret
    metadata:
      name: {{ $ap.clientSecretSecretRef.name }}
      labels: {{- $labels | toYaml | nindent 8 }}
    data:
      {{ $ap.clientSecretSecretRef.key }}: "{{ $cm.azureClientSecret | b64enc }}"
{{- end }}
{{- if eq $v.cluster.provider "google" }}
  - apiVersion: v1
    kind: Secret
    metadata:
      name: cloud-dns-key
      labels: {{- $labels | toYaml | nindent 8 }}
    data:
      key.json: "{{ $v | getOrNil "google.cloudDnsKey" | b64enc }}"
{{- end }}
{{- range $stage := (list "staging" "production") }}
  - apiVersion: cert-manager.io/v1alpha2
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-{{ $stage }}
      labels: {{- $labels | toYaml | nindent 8 }}
    spec:
      acme:
        server: https://acme{{ (eq $stage "staging") | ternary "-staging" "" }}-v02.api.letsencrypt.org/directory
        email: {{ $cm.email }}
        privateKeySecretRef:
          name: letsencrypt-{{ $stage }}
        solvers:
          - selector: {}
            dns01:
              {{- index $cm.provider $provider | toYaml | nindent 14 }}
{{- end }}
# generate all da certs
{{- range $domain, $certInfo := $vars.domains }}
  {{- if not $certInfo.hasCert }}
    {{- $certName := ($domain | replace "." "-") }}
  - {{ tpl $certTpl (merge (dict "domain" $domain "name" $certName "stage" $cm.stage "labels" $labels) $v) | nindent 4 }}
  {{- end }}
{{- end }}