{{- $v := .Environment.Values }}
{{- $c := $v.charts }}
{{- $d := $c | get "drone" dict }}
{{- $teams := keys $v.teamConfig.teams }}
{{- $teamNames := list -}}
{{- range $teams -}}
{{- $teamNames = print "team-" . | append $teamNames -}}
{{- end -}}

tasks:
  drone:
    type: job
    enabled: true
    description: Configure Drone to use the right pipeline file
    image:
      repository: "otomi/tasks"
      tag: "drone"
      pullPolicy: "Always"
    secret:
      DRONE_TOKEN: {{ $d | get "adminToken" }}
    env:
      DRONE_CONFIG_PATH: env/clouds/{{ $v.cluster.provider }}/{{ $v.cluster.name }}/.drone.yml
      DRONE_OWNER: {{ $d | get "owner" }}
      DRONE_REPO: {{ $d | get "repo" }}
      DRONE_URL: http://drone.team-admin
    script: npm run tasks:drone

