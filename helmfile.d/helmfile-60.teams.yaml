bases:
  - snippets/defaults.gotmpl
---
{{- $v := .Environment.Values }}
{{- $stack := $v | get "stack" dict }}
{{- $adminDomain := printf "%s%s.%s" $v.cluster.teamPrefix "admin" $v.cluster.domain }}
{{- $cm := index $v.charts "cert-manager" }}
{{- $po := index $v.charts "prometheus-operator" }}
{{- $tc := $v.teamConfig }}
releases:
  - name: team-ns-admin
    installed: true
    namespace: team-admin
    chart: ../charts/team-ns
    labels:
      tag: teams
    values:
      - name: admin
        teamId: admin
        cluster: {{- $v.cluster | toYaml | nindent 10 }}
        domain: {{ $adminDomain }}
        certStage: {{ $cm.stage }}
        services: {{- $v.services | toYaml | nindent 10 }}
        proxies: {{- $v.proxies | toYaml | nindent 10 }}
        resourceQuota: null
        knative:
          enabled: {{ $v.cluster.hasKnative }}
        ingress: {{- $v.ingress | toYaml | nindent 10 }}
  {{- range $teamId, $team := $tc.teams }}
  {{- $domain := printf "%s%s.%s" $v.cluster.teamPrefix $teamId $v.cluster.domain }}
  {{- $azure := $team | get "azure" dict }}
  - name: team-ns-{{ $teamId }}
    installed: true
    namespace: team-{{ $teamId }}
    chart: ../charts/team-ns
    labels:
      tag: teams
    values:
      - cluster: {{- $v.cluster | toYaml | nindent 10 }}
        domain: {{ $domain }}
        certStage: {{ $cm.stage }}
        knative:
          enabled: {{ $v.cluster.hasKnative }}
      - {{- $team | toYaml | nindent 8 }}
        teamId: {{ $teamId }}
      - services: {{- concat $tc.services ($team | get "services" list) | toYaml | nindent 12 }}
        {{- if $v.cluster.isMultitenant }}
        {{- if ($team | get "cicd.enabled" "false") }}
        {{- $cicdFlavour := ($team | get "cicd.type" "drone") }}
        {{- if eq $cicdFlavour "drone" }}
        # @todo: fix this weirdness: the next two lines fook the yaml parser:
        # - name: drone
        #   svc: drone-{{ $teamId }}
        {{- end }}
        {{- end }}
        {{- if ne (len ($team | get "sites" list)) 0 }}
        - name: blackbox
          svc: prom-blackbox-exporter
          port: 9115
        {{- end }}
        {{- end }}
  {{- if $v.cluster.isMultitenant }}        
  - name: prometheus-{{ $teamId }}
    {{- $promHost := printf "prometheus.%s" $domain }}
    {{- $alertsHost := printf "alertmanager.%s" $domain }}
    {{- $grafanaHost := printf "grafana.%s"  $domain }}
    installed: true
    namespace: team-{{ $teamId }}
    chart: ../charts/prometheus-operator
    labels:
      tag: teams
    values:
      - ../values/prometheus-operator/prometheus-operator.gotmpl
      - ../values/prometheus-operator/prometheus-operator-team.gotmpl
      - nameOverride: {{ $teamId }}-po
        fullnameOverride: {{ $teamId }}-po
        alertmanager:
          alertmanagerSpec:
            externalUrl: https://{{ $alertsHost }}
          config:
            {{- $receiver := ($team | get "receiver" ($po.alertmanager | get "receiver" "slack")) }}
            {{- if eq $receiver "slack" }}
            global:
              slack_api_url: {{ $team | get "slack.url" ($po.alertmanager | get "slack.url" $v.redkubesSlackUrl) }}
            {{- end }}
            receivers:
              - name: "null"
              {{- if eq $receiver "slack" }}
              {{- $channel := $team | get "slack.channel" "mon-otomi" }}
              - name: default
                slack_configs:
                  - channel: "#{{ $team | get "slack.channel" "mon-otomi" }}"
                    {{- readFile "../values/prometheus-operator/slack-configs.yaml" | replace "__CUSTOMER" $v.customerLabels.customer | nindent 20 | replace "__CLOUD" $v.cluster.provider | replace "__CLUSTER" $v.cluster.name }}
              - name: critical
                slack_configs:
                  - channel: "#{{ $team | get "slack.channel" "mon-otomi" }}-crit"
                    {{- readFile "../values/prometheus-operator/slack-configs.yaml" | replace "__CUSTOMER" $v.customerLabels.customer | nindent 20 | replace "__CLOUD" $v.cluster.provider | replace "__CLUSTER" $v.cluster.name }}
              {{- else }}
              {{ $suffix := (hasKey $team "receiver") | ternary "" ".monitoring.svc.cluster.local" }}
              - name: default
                webhook_configs:
                  - url: "http://prometheus-msteams{{ $suffix }}:2000/low_priority_channel"
                    send_resolved: true
              - name: critical
                webhook_configs:
                  - url: "http://prometheus-msteams{{ $suffix }}:2000/high_priority_channel"
                    send_resolved: true
              {{- end }}
              - name: critical-redkubes
              {{- if and $v.cluster.isRedkubesMonitored (hasKey $team "receiver") }}
                # sending team criticals also to redkubes to be aware of team issues
                slack_configs:
                  - channel: "#mon-otomi-crit"
                    api_url: {{ $v.redkubesSlackUrl }}
                    {{- readFile "../values/prometheus-operator/slack-configs.yaml" | nindent 20 | replace "__CUSTOMER" $v.customerLabels.customer | replace "__CLOUD" $v.cluster.provider | replace "__CLUSTER" $v.cluster.name }}
              {{- end }}
        prometheus:
          prometheusSpec:
            externalUrl: https://{{ $promHost }}
            ruleNamespaceSelector:
              matchLabels:
                name: team-{{ $teamId }}
            podMonitorNamespaceSelector:
              matchLabels:
                name: team-{{ $teamId }}
            serviceMonitorNamespaceSelector:
              matchLabels:
                name: team-{{ $teamId }}
        grafana:
          nameOverride: {{ $teamId }}-po-grafana
          fullnameOverride: {{ $teamId }}-po-grafana
          grafana.ini:
            server:
              root_url: https://{{ $grafanaHost }}
            {{- if hasKey $team "oidc" }}
            "auth.generic_oauth":
              client_id: {{ $team.oidc.clientID }}
              client_secret: {{ $team.oidc.clientSecret }}
            {{- end }}
          additionalDataSources:
            - name: Prometheus-Istio
              editable: false
              type: prometheus
              access: proxy
              url: http://prometheus.istio-system:9090
            - name: Loki
              editable: false
              type: loki
              access: proxy
              url: http://loki.monitoring:11811
              basicAuth: true
              basicAuthUser: {{ $teamId }}
              basicAuthPassword: {{ $team.password }}
            {{- if $stack | get "enabled.sitespeed" false }}
            - name: Graphite
              editable: false
              type: graphite
              access: proxy
              url: http://graphite.monitoring:80
            {{- end }}
            {{- if and (eq $v.cluster.provider "azure") ($team | get "azure.monitor" false) }}
            {{- $monitor := (($team | get "azure.monitor.useAdmin" false) | ternary ($v.azure | getOrNil "monitor") ($team | getOrNil "azure.monitor")) }}
            {{- with $monitor }}
            - name: Azure Monitor
              type: grafana-azure-monitor-datasource
              access: proxy
              jsonData:
                cloudName: azuremonitor
                subscriptionId: {{ $v.azure.subscriptionId }}
                tenantId: {{ $v.azure.tenantId }}
                clientId: {{ .clientId }}
                logAnalyticsTenantId: {{ . | get "logAnalyticsTenantId" $v.azure.tenantId }}
                logAnalyticsClientId: {{ . | get "logAnalyticsClientId" .clientId }}
                logAnalyticsDefaultWorkspace: {{ .logAnalyticsWorkspace }}
                appInsightsAppId: {{ . | get "appInsightsAppId" .clientId }}
                azureLogAnalyticsSameAs: true
                keepCookies: []
              secureJsonData:
                clientSecret: {{ .clientSecret }}
                logAnalyticsClientSecret: {{ . | get "logAnalyticsClientSecret" .clientSecret }}
                appInsightsAppSecret : {{ . | get "appInsightsAppSecret" .clientSecret }}
              version: 4
              editable: false
            {{- end }}
            {{- end }}
  {{ if eq ($team | get "receiver" "slack") "msteams" }}
  - name: prometheus-msteams-{{ $teamId }}
    installed: true
    namespace: team-{{ $teamId }}
    chart: ../charts/prometheus-msteams
    labels:
      tag: teams
    values:
      - ../values/prometheus-msteams/prometheus-msteams.gotmpl
      - ../values/default.gotmpl
      - commonLabels:
          team: {{ $teamId }}
        metrics:
          serviceMonitor:
            additionalLabels:
              release: prometheus-{{ $teamId }}
        connectors:
          - high_priority_channel: {{ $team | get "msteams.highPrio" ($po | get "alertmanager.msteams.highPrio") }}
          - low_priority_channel: {{ $team | get "msteams.lowPrio" ($po | get "alertmanager.msteams.lowPrio") }}
  {{- end }}

  - name: grafana-dashboards-{{ $teamId }}
    installed: true
    namespace: team-{{ $teamId }}
    chart: ../charts/grafana-dashboards
    labels:
      tag: teams
    values:
      - ../values/grafana-dashboards/grafana-dashboards.gotmpl
      - ../values/default.gotmpl
      - cluster: {{- $v.cluster | toYaml | nindent 10 }}
        team: {{ $teamId }}
        folders:
          - k8s
          - istio
          {{- if and (eq $v.cluster.provider "azure") (hasKey $azure "monitor") }}
          - azure{{ end }}
          {{- if $team | get "stack.sitespeed" false }}
          - sitespeed{{ end }}

  - name: index-{{ $teamId }}
    installed: true
    namespace: team-{{ $teamId }}
    chart: ../charts/index
    labels:
      tag: teams
      pkg: index
    values:
      - ../values/index/index.gotmpl
      - ../values/default.gotmpl
      - domain: {{ $domain }}
        group: {{ $teamId }}
        coreServices:
          {{- range $s := $tc.services }}
          {{- if and (not (eq $s.name "index")) (not (index $s "isAuthProxy")) (not (index $s "internal")) }}
          - {{ $s | toYaml | replace "#NS#" (printf "team-%s" $teamId) | nindent 12 }}
          {{- end }}
          {{- end }}
        services: {{- $team | get "services" list | toYaml | nindent 10 }}
  {{- if ($team | get "cicd.enabled" "false") }}
  {{- $cicdFlavour := ($team | get "cicd.type" "drone") }}
  {{- if eq $cicdFlavour "drone" }}
  # - name: drone-{{ $teamId }}
  #   installed: true # @todo: set up values and enable
  #   namespace: team-{{ $teamId }}
  #   chart: ../charts/drone
  #   labels:
  #     tag: teams
  #     pkg: cicd
  #   values:
  #     - ../values/drone/drone.gotmpl
  #     - ../values/default.gotmpl
  #     - env:
  #         DRONE_SERVER_PROXY_HOST: proxy.{{ $domain }}/drone

  {{- end }}
  {{- end }}
  {{- end }}
  - name: oauth2-proxy-team-{{ $teamId }}
    installed: true
    namespace: istio-system
    chart: ../charts/oauth2-proxy
    labels:
      team: {{ $teamId }}
      tag: ingress
      pkg: oauth2-proxy
    values:
      - ../values/oauth2-proxy/oauth2-proxy.gotmpl
      - ../values/default.gotmpl
      - fullnameOverride: oauth2-proxy-team-{{ $teamId }}
        {{- if hasKey $team "oidc" }}
        config:
          clientID: {{ $team.oidc.clientID }}
          clientSecret: {{ $team.oidc.clientSecret }}
        {{- end }}
        extraArgs:
          whitelist-domain: {{ $domain }}
          redirect-url: https://auth.{{ $domain }}/oauth2/callback
          cookie-domain: {{ $domain }}
  {{- end }}
